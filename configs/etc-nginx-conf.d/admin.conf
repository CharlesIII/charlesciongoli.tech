server {
        listen 443 ssl http2;
        listen [::]:443 ssl http2;
        server_name admin.charlesciongoli.tech;
#        ssl_certificate /etc/nginx/ssl/nginx.crt;
#        ssl_certificate_key /etc/nginx/ssl/nginx.key;
#        ssl_certificate /etc/ssl/certs/nginx-selfsigned.crt;
#        ssl_certificate_key /etc/ssl/private/nginx-selfsigned.key;
        ssl_certificate /etc/letsencrypt/live/charlesciongoli.tech/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/charlesciongoli.tech/privkey.pem;
		ssl_session_timeout 1d;
		ssl_session_cache shared:MozSSL:10m;  # about 40000 sessions
		ssl_session_tickets off;

		# curl https://ssl-config.mozilla.org/ffdhe2048.txt > /path/to/dhparam.pem
		ssl_dhparam /etc/ssl/dhparam.pem;
		ssl_ecdh_curve       secp384r1;

		# intermediate configuration
		ssl_protocols TLSv1.2 TLSv1.3;
		ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384;
		ssl_prefer_server_ciphers off;

		# HSTS (ngx_http_headers_module is required) (63072000 seconds)
		add_header Strict-Transport-Security "max-age=63072000; includeSubDomains" always;

		# OCSP stapling
		ssl_stapling on;
		ssl_stapling_verify on;

		# verify chain of trust of OCSP response using Root CA and Intermediate certs
		ssl_trusted_certificate /etc/letsencrypt/live/charlesciongoli.tech/chain.pem;

		# replace with the IP address of your resolver
		resolver 1.1.1.1 1.0.0.1;
		resolver_timeout 10s;

		add_header X-Frame-Options SAMEORIGIN;
		add_header X-Content-Type-Options nosniff;

	root /var/www/html/admin;
	index index.php index.html index.htm;

		location ~ ^/(status|ping)$ {
			include fastcgi_params;
			fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
			fastcgi_pass fastcgi_backend;
#			allow 127.0.0.1;
#			deny all;
		}

    location /opcachegui {
#	autoindex on;
#	autoindex_exact_size off;
 #       index index.php;
#        rewrite ^/opcachegui/(.*)$ /OpCacheGUI/$1 break;
#        alias /var/www/html/admin/OpCacheGUI/public;
        try_files $uri $uri/ /public/index.php?$args;

#        auth_basic "OpCacheGUI Login";
#        auth_basic_user_file /var/www/html/admin/OpCacheGUI/.htpasswd;

        location ~* \.php$ {
        #location ~ /opcachegui/(.+\.php)$ {
            include fastcgi_params;
#	fastcgi_index  index.php;
            fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
            fastcgi_pass fastcgi_backend;

        }
    }

    location ~/landscape(.*)$ {
      proxy_pass https://10.1.96.6$1;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_hide_header X-Frame-Options;
      proxy_http_version 1.1;
			proxy_buffering off;
			proxy_set_header Upgrade $http_upgrade;
			proxy_set_header Connection "upgrade";
      proxy_set_header Accept-Encoding "";

      sub_filter_types *;
      #sub_filter 'admin.charlesciongoli.tech' 'admin.charlesciongoli.tech/landscape';
      sub_filter 'src="' 'src="landscape/';
      sub_filter 'href="' 'href="landscape/';
      sub_filter_once off;

    }

		location /webserver {
			# Required to proxy the connection to Cockpit
			#rewrite /webserver/(.*) /$1  break;
			proxy_pass https://127.0.0.1:9090;
			proxy_set_header Host $host;
			proxy_set_header X-Forwarded-Proto $scheme;
			#proxy_set_header X-Frame-Options "ALLOW-FROM charlesciongoli.tech";
			#proxy_set_header Content-Security-Policy "frame-ancestors charlesciongoli.tech";
			#proxy_hide_header X-Frame-Options;

			# Required for web sockets to function
			proxy_http_version 1.1;
			proxy_buffering off;
			proxy_set_header Upgrade $http_upgrade;
			proxy_set_header Connection "upgrade";

			# Pass ETag header from Cockpit to clients.
			# See: https://github.com/cockpit-project/cockpit/issues/5239
			gzip off;
		}
		location /dbserver {
			# Required to proxy the connection to Cockpit
			proxy_pass https://10.1.96.3:9090;
			proxy_redirect https://10.1.96.3:9090/ /dbserver;
			proxy_set_header Host $host;
			proxy_set_header X-Forwarded-Proto $scheme;

			# Required for web sockets to function
			proxy_http_version 1.1;
			proxy_buffering off;
			proxy_set_header Upgrade $http_upgrade;
			proxy_set_header Connection "upgrade";

			# Pass ETag header from Cockpit to clients.
			# See: https://github.com/cockpit-project/cockpit/issues/5239
			gzip off;
		}

		location /phpmyadmin {
		  root /usr/share/;
#		  index index.php;
		  try_files $uri $uri/ =404;

#		  location ~ ^/phpmyadmin/doc/ {
#			   index index.html;
#		  }

		  location ~ ^/phpmyadmin/(sql|setup)/ {
			   deny all;
		  }

		  location ~ /phpmyadmin/(.+\.php)$ {
  			fastcgi_pass fastcgi_backend;
  			fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
  			include fastcgi_params;
  #			include snippets/fastcgi-php.conf;
		  }
		 }
}
